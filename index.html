<html lang="en-GB">

<head>
    <meta charset="utf-8" />
    <title>Abstractus</title>
</head>

<body>
    <p>
        <input type="file" id="source-selector" accept=".png" onchange="onSourceChanged();">
        <button onclick="onSourceChanged();">Resubmit</button>
    </p>
    <hr />
    <p>
        <h3>Rotation correction <button id="rotation-toggle" onclick="toggleSection(SECTION.ROTATION);">Show</button>
        </h3>
    </p>
    <div id="rotation-div" style="display:none"></div>
    <hr />
    <p>
        <h3>Bwify <button id="bwify-toggle" onclick="toggleSection(SECTION.BWIFY);">Show</button>
        <table><tr>
            <td>Cutoff:</td>
            <td><input type="number" min="0.0" max="1.0" step="0.02" id="bwify-thresh-number" style="width:50px" onchange="bwifyNumberChanged();"></td>
            <td><input type="range" min="0.0" max="1.0" step="0.02" class="slider" id="bwify-thresh-slider" onchange="bwifySliderChanged()"></td>
            <td><button id="bwifyReset" onclick="bwifyNumber.value=bwifyParams.defaultIntensityThreshold; bwifyNumberChanged()">Reset</button></td>
        </tr></table></h3>
    </p>
    <div id="bwify-div" style="display:none">
        <canvas id="bwify-canvas"></canvas>
    </div>
    <hr />
    <p>
        <h3>Degridding <button id="degrid-toggle" onclick="toggleSection(SECTION.DEGRID);">Show</button></h3>
    </p>
    <div id="degrid-div" style="display:none"></div>
    <hr />
    <p>
        <h3>Clean <button id="clean-toggle" onclick="toggleSection(SECTION.CLEAN);">Show</button></h3>
        <div id="clean-div" style="display:block"></div>
    </p>
</body>

<script src="rotation.js"></script>
<script src="bwify.js"></script>
<script src="degrid.js"></script>
<script src="clean.js"></script>
<script>

    const sourceSelector = document.getElementById("source-selector");

    // UI stuff

    const SECTION = {
        ROTATION: 0,
        BWIFY: 1,
        DEGRID: 2,
        CLEAN: 3
    }
    const sectionNames = [
        "rotation",
        "bwify",
        "degrid",
        "clean"
    ]
    const sectionToggles = [];
    const sectionDivs = [];
    for (let i = 0; i < sectionNames.length; i++) {
        sectionToggles.push(document.getElementById(sectionNames[i] + "-toggle"));
        sectionDivs.push(document.getElementById(sectionNames[i] + "-div"));
    }

    function toggleSection(i) {
        if (sectionToggles[i].innerText == "Show") {
            sectionDivs[i].style.display = "block";
            sectionToggles[i].innerText = "Hide";
        } else {
            sectionDivs[i].style.display = "none";
            sectionToggles[i].innerText = "Show";
        }
    }

    function clearSection(i) {
        while (sectionDivs[i].lastElementChild)
            sectionDivs[i].removeChild(sectionDivs[i].lastElementChild);
        sectionDivs[i].innerText = "";
    }

    // Processing stuff

    const CANVAS = {
        ORIGINAL: 0,
        ROTATED: 1,
        BW: 2,
        DEGRIDDED: 3,
        POSTCROP: 4,
        POSTCLEAN: 5,
        FINAL: 6
    }
    let canvases; // array over CANVAS.
    let contexts;

    let w; let h; // width and height of image
    let w2; let wh; // width and height of chart area
    let l = 0; let r = 0; let t = 0; let b = 0; // bounds of *chart area*

    let rotatedBitmap; // bitmap data of canvases[CANVAS.ROTATED]
    let bwBitmap;      // bitmap data of canvases[CANVAS.BW]

    let progress = -1;

    function onSourceChanged() {

        if (sourceSelector.files.length == 0)
            return;

        const promise = createImageBitmap(sourceSelector.files[0]);
        promise.then(processBitmap, (reason) => alert("Image could not be loaded:" + reason));

    }

    function processBitmap(bitmap) {

        w = bitmap.width;
        h = bitmap.height;

        canvases = [];
        contexts = [];
        for (let i = 0; i < CANVAS.POSTCROP; i++) {
            canvases.push(document.createElement("canvas"));
            canvases[i].width = w; canvases[i].height = h;
            contexts.push(canvases[i].getContext("2d"));
        }

        contexts[CANVAS.ORIGINAL].drawImage(bitmap, 0, 0);
        bitmap.close();

        // Begin recomputation cascade
        recomputeRotation();

    }


</script>

</html>